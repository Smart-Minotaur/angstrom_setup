#!/bin/bash

# Enables SPI0 and SPI1 on device tree for BeagleBone Black and Angstrom Linux.

# Warning! On the newest angstrom image there is no dtc in opkg available.
# A simple solution is to create the compiled dtbo file on a desktop ubuntu machine
# and copy it to the BBB.

cat /sys/devices/bone_capemgr.9/slots

# Compile overlay.
if [ -n "$1" ]
then
	dtc -O dtb -o MINOTAUR-SPI0-00A0.dtbo -b 0 -@ MINOTAUR-SPI0-00A0.dts
	dtc -O dtb -o MINOTAUR-SPI1-00A0.dtbo -b 0 -@ MINOTAUR-SPI1-00A0.dts
fi

# Copy compiled file.
cp MINOTAUR-SPI0-00A0.dtbo /lib/firmware/
cp MINOTAUR-SPI1-00A0.dtbo /lib/firmware/

# Enable overlay
echo MINOTAUR-SPI0 > /sys/devices/bone_capemgr.*/slots
echo MINOTAUR-SPI1 > /sys/devices/bone_capemgr.*/slots

# Add manualy to uEnv.txt
# mkdir /mnt/boot
# mount /dev/mmcblk0p1 /mnt/boot
# capemgr.enable_partno=<name>

cat /sys/devices/bone_capemgr.9/slots

